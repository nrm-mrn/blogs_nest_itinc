{"version":3,"sources":["../../../../../src/modules/user-accounts/application/queries/get-all-users.query.ts"],"sourcesContent":["import { IQueryHandler, QueryHandler } from '@nestjs/cqrs';\nimport { GetUsersQueryParams } from '../../api/input-dto/get-users-query-params.input-dto';\nimport { PaginatedViewDto } from 'src/core/dto/base.paginated.view-dto';\nimport { UserViewDto } from '../../api/view-dto/users.view-dto';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { User, UserDocument, UserModelType } from '../../domain/user.entity';\nimport { FilterQuery } from 'mongoose';\n\nexport class GetAllUsersQuery {\n  constructor(public params: GetUsersQueryParams) {}\n}\n\n@QueryHandler(GetAllUsersQuery)\nexport class GetAllUsersQueryHandler\n  implements IQueryHandler<GetAllUsersQuery, PaginatedViewDto<UserViewDto[]>>\n{\n  constructor(\n    @InjectModel(User.name) private readonly UserModel: UserModelType,\n  ) {}\n\n  async execute(\n    query: GetAllUsersQuery,\n  ): Promise<PaginatedViewDto<UserViewDto[]>> {\n    const filter = this.getFilter(query.params);\n    const users = await this.UserModel.find(filter)\n      .sort({ [query.params.sortBy]: query.params.sortDirection })\n      .skip(query.params.calculateSkip())\n      .limit(query.params.pageSize)\n      .exec();\n    const total = await this.UserModel.countDocuments(filter).exec();\n    const usersView = users.map((user) => {\n      return UserViewDto.mapToView(user);\n    });\n    return PaginatedViewDto.mapToView({\n      items: usersView,\n      page: query.params.pageNumber,\n      size: query.params.pageSize,\n      totalCount: total,\n    });\n  }\n\n  private getFilter(dto: GetUsersQueryParams): FilterQuery<UserDocument> {\n    const filter: FilterQuery<UserDocument> = { deletedAt: null };\n    let searchLogin: FilterQuery<UserDocument> | null = null;\n    let searchEmail: FilterQuery<UserDocument> | null = null;\n    if ('searchLoginTerm' in dto && dto.searchLoginTerm !== null) {\n      searchLogin = { login: { $regex: dto.searchLoginTerm, $options: 'i' } };\n    }\n    if ('searchEmailTerm' in dto && dto.searchEmailTerm !== null) {\n      searchEmail = { email: { $regex: dto.searchEmailTerm, $options: 'i' } };\n    }\n    if (searchLogin) {\n      if (searchEmail) {\n        return { ...filter, $or: [searchEmail, searchLogin] };\n      }\n      return { ...filter, $or: [searchLogin] };\n    }\n    if (searchEmail) {\n      return { ...filter, $or: [searchEmail] };\n    }\n    return filter;\n  }\n}\n"],"names":["GetAllUsersQuery","GetAllUsersQueryHandler","constructor","params","execute","query","filter","getFilter","users","UserModel","find","sort","sortBy","sortDirection","skip","calculateSkip","limit","pageSize","exec","total","countDocuments","usersView","map","user","UserViewDto","mapToView","PaginatedViewDto","items","page","pageNumber","size","totalCount","dto","deletedAt","searchLogin","searchEmail","searchLoginTerm","login","$regex","$options","searchEmailTerm","email","$or","name"],"mappings":";;;;;;;;;;;QAQaA;eAAAA;;QAKAC;eAAAA;;;sBAb+B;sCAEX;8BACL;0BACA;4BACsB;;;;;;;;;;;;;;;AAG3C,IAAA,AAAMD,mBAAN,MAAMA;IACXE,YAAY,AAAOC,MAA2B,CAAE;aAA7BA,SAAAA;IAA8B;AACnD;AAGO,IAAA,AAAMF,0BAAN,MAAMA;IAOX,MAAMG,QACJC,KAAuB,EACmB;QAC1C,MAAMC,SAAS,IAAI,CAACC,SAAS,CAACF,MAAMF,MAAM;QAC1C,MAAMK,QAAQ,MAAM,IAAI,CAACC,SAAS,CAACC,IAAI,CAACJ,QACrCK,IAAI,CAAC;YAAE,CAACN,MAAMF,MAAM,CAACS,MAAM,CAAC,EAAEP,MAAMF,MAAM,CAACU,aAAa;QAAC,GACzDC,IAAI,CAACT,MAAMF,MAAM,CAACY,aAAa,IAC/BC,KAAK,CAACX,MAAMF,MAAM,CAACc,QAAQ,EAC3BC,IAAI;QACP,MAAMC,QAAQ,MAAM,IAAI,CAACV,SAAS,CAACW,cAAc,CAACd,QAAQY,IAAI;QAC9D,MAAMG,YAAYb,MAAMc,GAAG,CAAC,CAACC;YAC3B,OAAOC,yBAAW,CAACC,SAAS,CAACF;QAC/B;QACA,OAAOG,sCAAgB,CAACD,SAAS,CAAC;YAChCE,OAAON;YACPO,MAAMvB,MAAMF,MAAM,CAAC0B,UAAU;YAC7BC,MAAMzB,MAAMF,MAAM,CAACc,QAAQ;YAC3Bc,YAAYZ;QACd;IACF;IAEQZ,UAAUyB,GAAwB,EAA6B;QACrE,MAAM1B,SAAoC;YAAE2B,WAAW;QAAK;QAC5D,IAAIC,cAAgD;QACpD,IAAIC,cAAgD;QACpD,IAAI,qBAAqBH,OAAOA,IAAII,eAAe,KAAK,MAAM;YAC5DF,cAAc;gBAAEG,OAAO;oBAAEC,QAAQN,IAAII,eAAe;oBAAEG,UAAU;gBAAI;YAAE;QACxE;QACA,IAAI,qBAAqBP,OAAOA,IAAIQ,eAAe,KAAK,MAAM;YAC5DL,cAAc;gBAAEM,OAAO;oBAAEH,QAAQN,IAAIQ,eAAe;oBAAED,UAAU;gBAAI;YAAE;QACxE;QACA,IAAIL,aAAa;YACf,IAAIC,aAAa;gBACf,OAAO;oBAAE,GAAG7B,MAAM;oBAAEoC,KAAK;wBAACP;wBAAaD;qBAAY;gBAAC;YACtD;YACA,OAAO;gBAAE,GAAG5B,MAAM;gBAAEoC,KAAK;oBAACR;iBAAY;YAAC;QACzC;QACA,IAAIC,aAAa;YACf,OAAO;gBAAE,GAAG7B,MAAM;gBAAEoC,KAAK;oBAACP;iBAAY;YAAC;QACzC;QACA,OAAO7B;IACT;IA7CAJ,YACE,AAAyCO,SAAwB,CACjE;aADyCA,YAAAA;IACxC;AA4CL;;;6DA7CsBkC"}