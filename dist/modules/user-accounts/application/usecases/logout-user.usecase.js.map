{"version":3,"sources":["../../../../../src/modules/user-accounts/application/usecases/logout-user.usecase.ts"],"sourcesContent":["import { Inject } from '@nestjs/common';\nimport { CommandHandler, ICommandHandler } from '@nestjs/cqrs';\nimport { JwtService } from '@nestjs/jwt';\nimport { REFRESH_TOKEN_STRATEGY_INJECT_TOKEN } from '../../constants/auth-token.inject-constants';\nimport { CreateRefreshTokenDto } from '../../dto/create-refresh-token.dto';\nimport { DevicesSecurityRepository } from '../../infrastructure/devices-security.repository';\n\nexport class LogoutCommand {\n  constructor(public token: string) {}\n}\n\n@CommandHandler(LogoutCommand)\nexport class LogoutCommandHandler implements ICommandHandler<LogoutCommand> {\n  constructor(\n    private readonly sessionsRepository: DevicesSecurityRepository,\n    @Inject(REFRESH_TOKEN_STRATEGY_INJECT_TOKEN)\n    private readonly jwtRefreshTokService: JwtService,\n  ) {}\n\n  async execute(command: LogoutCommand): Promise<any> {\n    const payload = this.jwtRefreshTokService.verify<CreateRefreshTokenDto>(\n      command.token,\n    );\n    //NOTE: check that refresh token session is active\n    const session = await this.sessionsRepository.findSessionOrFail(\n      payload.deviceId,\n      payload.iat,\n    );\n    return this.sessionsRepository.deleteSession(session);\n  }\n}\n"],"names":["LogoutCommand","LogoutCommandHandler","constructor","token","execute","command","payload","jwtRefreshTokService","verify","session","sessionsRepository","findSessionOrFail","deviceId","iat","deleteSession"],"mappings":";;;;;;;;;;;QAOaA;eAAAA;;QAKAC;eAAAA;;;wBAZU;sBACyB;qBACrB;0CACyB;2CAEV;;;;;;;;;;;;;;;AAEnC,IAAA,AAAMD,gBAAN,MAAMA;IACXE,YAAY,AAAOC,KAAa,CAAE;aAAfA,QAAAA;IAAgB;AACrC;AAGO,IAAA,AAAMF,uBAAN,MAAMA;IAOX,MAAMG,QAAQC,OAAsB,EAAgB;QAClD,MAAMC,UAAU,IAAI,CAACC,oBAAoB,CAACC,MAAM,CAC9CH,QAAQF,KAAK;QAEf,kDAAkD;QAClD,MAAMM,UAAU,MAAM,IAAI,CAACC,kBAAkB,CAACC,iBAAiB,CAC7DL,QAAQM,QAAQ,EAChBN,QAAQO,GAAG;QAEb,OAAO,IAAI,CAACH,kBAAkB,CAACI,aAAa,CAACL;IAC/C;IAhBAP,YACE,AAAiBQ,kBAA6C,EAC9D,AACiBH,oBAAgC,CACjD;aAHiBG,qBAAAA;aAEAH,uBAAAA;IAChB;AAaL"}