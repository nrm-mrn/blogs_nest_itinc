{"version":3,"sources":["../../../../../src/modules/bloggers-platform/blogs/infrastructure/blogs.query-repository.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { Blog, BlogDocument, BlogModelType } from '../domain/blog.entity';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { GetBlogsQueryParams } from '../api/input-dto/get-blogs-query-params.input-dto';\nimport { PaginatedViewDto } from 'src/core/dto/base.paginated.view-dto';\nimport { BlogViewDto } from '../api/view-dto/blogs.view-dto';\nimport { FilterQuery } from 'mongoose';\nimport { DomainException } from 'src/core/exceptions/domain-exceptions';\nimport { DomainExceptionCode } from 'src/core/exceptions/domain-exception-codes';\nimport { Post, PostModelType } from '../../posts/domain/post.entity';\nimport { GetBlogPostsDto } from '../api/view-dto/get-blog-posts-dto';\nimport { PostViewDto } from '../../posts/api/view-dto/posts.view-dto';\n\n@Injectable()\nexport class BlogsQueryRepository {\n  constructor(\n    @InjectModel(Blog.name) private readonly BlogModel: BlogModelType,\n    @InjectModel(Post.name) private readonly PostModel: PostModelType,\n  ) {}\n\n  getFilter(\n    dto: GetBlogsQueryParams | GetBlogPostsDto,\n  ): FilterQuery<BlogDocument> {\n    let byId = {};\n    let search = {};\n    if ('blogId' in dto) {\n      byId = { blogId: dto.blogId };\n    }\n    if ('searchNameTerm' in dto && dto.searchNameTerm !== null) {\n      search = { name: { $regex: dto.searchNameTerm, $options: 'i' } };\n    }\n    return { ...byId, ...search, deletedAt: null };\n  }\n\n  async getAllBlogs(\n    dto: GetBlogsQueryParams,\n  ): Promise<PaginatedViewDto<BlogViewDto[]>> {\n    const filter = this.getFilter(dto);\n    const blogs = await this.BlogModel.find(filter)\n      .sort({ [dto.sortBy]: dto.sortDirection })\n      .skip(dto.calculateSkip())\n      .limit(dto.pageSize)\n      .exec();\n    const total = await this.BlogModel.countDocuments(filter).exec();\n    const blogViews: BlogViewDto[] = blogs.map((blog) => {\n      return BlogViewDto.mapToView(blog);\n    });\n\n    return PaginatedViewDto.mapToView({\n      items: blogViews,\n      page: dto.pageNumber,\n      size: dto.pageSize,\n      totalCount: total,\n    });\n  }\n\n  async getBlogPosts(\n    dto: GetBlogPostsDto,\n  ): Promise<PaginatedViewDto<PostViewDto[]>> {\n    const filter = this.getFilter(dto);\n    const posts = await this.PostModel.find(filter)\n      .sort({ [dto.sortBy]: dto.sortDirection })\n      .skip(dto.calculateSkip())\n      .limit(dto.pageSize)\n      .exec();\n    const total = await this.PostModel.countDocuments(filter);\n    const postViews: PostViewDto[] = posts.map((post) => {\n      return PostViewDto.mapToView(post);\n    });\n    return PaginatedViewDto.mapToView({\n      items: postViews,\n      page: dto.pageNumber,\n      size: dto.pageSize,\n      totalCount: total,\n    });\n  }\n\n  async findBlogOrNotFoundFail(id: string): Promise<BlogViewDto> {\n    const blog = await this.BlogModel.findOne({\n      _id: id,\n      deletedAt: null,\n    }).orFail(\n      new DomainException({\n        code: DomainExceptionCode.NotFound,\n        message: 'Blog not found',\n      }),\n    );\n    return BlogViewDto.mapToView(blog);\n  }\n}\n"],"names":["BlogsQueryRepository","getFilter","dto","byId","search","blogId","searchNameTerm","name","$regex","$options","deletedAt","getAllBlogs","filter","blogs","BlogModel","find","sort","sortBy","sortDirection","skip","calculateSkip","limit","pageSize","exec","total","countDocuments","blogViews","map","blog","BlogViewDto","mapToView","PaginatedViewDto","items","page","pageNumber","size","totalCount","getBlogPosts","posts","PostModel","postViews","post","PostViewDto","findBlogOrNotFoundFail","id","findOne","_id","orFail","DomainException","code","DomainExceptionCode","NotFound","message","constructor"],"mappings":";;;;+BAcaA;;;eAAAA;;;wBAdc;4BACuB;0BACtB;sCAEK;8BACL;kCAEI;sCACI;4BACA;8BAER;;;;;;;;;;;;;;;AAGrB,IAAA,AAAMA,uBAAN,MAAMA;IAMXC,UACEC,GAA0C,EACf;QAC3B,IAAIC,OAAO,CAAC;QACZ,IAAIC,SAAS,CAAC;QACd,IAAI,YAAYF,KAAK;YACnBC,OAAO;gBAAEE,QAAQH,IAAIG,MAAM;YAAC;QAC9B;QACA,IAAI,oBAAoBH,OAAOA,IAAII,cAAc,KAAK,MAAM;YAC1DF,SAAS;gBAAEG,MAAM;oBAAEC,QAAQN,IAAII,cAAc;oBAAEG,UAAU;gBAAI;YAAE;QACjE;QACA,OAAO;YAAE,GAAGN,IAAI;YAAE,GAAGC,MAAM;YAAEM,WAAW;QAAK;IAC/C;IAEA,MAAMC,YACJT,GAAwB,EACkB;QAC1C,MAAMU,SAAS,IAAI,CAACX,SAAS,CAACC;QAC9B,MAAMW,QAAQ,MAAM,IAAI,CAACC,SAAS,CAACC,IAAI,CAACH,QACrCI,IAAI,CAAC;YAAE,CAACd,IAAIe,MAAM,CAAC,EAAEf,IAAIgB,aAAa;QAAC,GACvCC,IAAI,CAACjB,IAAIkB,aAAa,IACtBC,KAAK,CAACnB,IAAIoB,QAAQ,EAClBC,IAAI;QACP,MAAMC,QAAQ,MAAM,IAAI,CAACV,SAAS,CAACW,cAAc,CAACb,QAAQW,IAAI;QAC9D,MAAMG,YAA2Bb,MAAMc,GAAG,CAAC,CAACC;YAC1C,OAAOC,yBAAW,CAACC,SAAS,CAACF;QAC/B;QAEA,OAAOG,sCAAgB,CAACD,SAAS,CAAC;YAChCE,OAAON;YACPO,MAAM/B,IAAIgC,UAAU;YACpBC,MAAMjC,IAAIoB,QAAQ;YAClBc,YAAYZ;QACd;IACF;IAEA,MAAMa,aACJnC,GAAoB,EACsB;QAC1C,MAAMU,SAAS,IAAI,CAACX,SAAS,CAACC;QAC9B,MAAMoC,QAAQ,MAAM,IAAI,CAACC,SAAS,CAACxB,IAAI,CAACH,QACrCI,IAAI,CAAC;YAAE,CAACd,IAAIe,MAAM,CAAC,EAAEf,IAAIgB,aAAa;QAAC,GACvCC,IAAI,CAACjB,IAAIkB,aAAa,IACtBC,KAAK,CAACnB,IAAIoB,QAAQ,EAClBC,IAAI;QACP,MAAMC,QAAQ,MAAM,IAAI,CAACe,SAAS,CAACd,cAAc,CAACb;QAClD,MAAM4B,YAA2BF,MAAMX,GAAG,CAAC,CAACc;YAC1C,OAAOC,yBAAW,CAACZ,SAAS,CAACW;QAC/B;QACA,OAAOV,sCAAgB,CAACD,SAAS,CAAC;YAChCE,OAAOQ;YACPP,MAAM/B,IAAIgC,UAAU;YACpBC,MAAMjC,IAAIoB,QAAQ;YAClBc,YAAYZ;QACd;IACF;IAEA,MAAMmB,uBAAuBC,EAAU,EAAwB;QAC7D,MAAMhB,OAAO,MAAM,IAAI,CAACd,SAAS,CAAC+B,OAAO,CAAC;YACxCC,KAAKF;YACLlC,WAAW;QACb,GAAGqC,MAAM,CACP,IAAIC,iCAAe,CAAC;YAClBC,MAAMC,yCAAmB,CAACC,QAAQ;YAClCC,SAAS;QACX;QAEF,OAAOvB,yBAAW,CAACC,SAAS,CAACF;IAC/B;IAzEAyB,YACE,AAAyCvC,SAAwB,EACjE,AAAyCyB,SAAwB,CACjE;aAFyCzB,YAAAA;aACAyB,YAAAA;IACxC;AAuEL;;;6DAzEsBhC;6DACAA"}