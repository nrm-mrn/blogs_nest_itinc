{"version":3,"sources":["../../../../../src/modules/bloggers-platform/posts/domain/post.entity.ts"],"sourcesContent":["import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';\nimport { HydratedDocument, Model } from 'mongoose';\nimport { UpdatePostDto } from '../dto/update-post.dto';\nimport { DomainException } from 'src/core/exceptions/domain-exceptions';\nimport { DomainExceptionCode } from 'src/core/exceptions/domain-exception-codes';\nimport { CreatePostDomainDto } from './dto/create-post-domain-dto';\nimport {\n  ExtendedLikesInfo,\n  ExtendedLikesInfoSchema,\n} from './extendedLikes.schema';\nimport { PostLikeDocument } from './postLike.entity';\n\nexport const postTitleConstr = {\n  maxLength: 30,\n};\nexport const postDescriptionConstr = {\n  maxLength: 100,\n};\nexport const postContentConstr = {\n  maxLength: 1000,\n};\n\n/**\n * Post entity schema\n * This class represents the schema and behaviour of the post entity\n */\n@Schema({ timestamps: true })\nexport class Post {\n  /**\n   * Post title\n   * @type {string}\n   */\n  @Prop({ type: String, required: true, ...postTitleConstr })\n  title: string;\n\n  /**\n   * Post short description\n   * @type {string}\n   */\n  @Prop({ type: String, required: true, ...postDescriptionConstr })\n  shortDescription: string;\n\n  /**\n   * Post content\n   * @type {string}\n   */\n  @Prop({ type: String, required: true, ...postContentConstr })\n  content: string;\n\n  /**\n   * Post's parent blog id\n   * @type {string}\n   */\n  @Prop({ type: String, required: true })\n  blogId: string;\n\n  @Prop({ type: ExtendedLikesInfoSchema, default: new ExtendedLikesInfo() })\n  extendedLikesInfo: ExtendedLikesInfo;\n\n  /**\n   * Post's parent blog name\n   * @type {string}\n   */\n  @Prop({ type: String, required: true })\n  blogName: string;\n\n  /**\n   * Timestamps\n   * @type {Date}\n   */\n  createdAt: Date;\n  updatedAt: Date;\n\n  /**\n   * Deletion timestamp\n   * nullable, if exists - means entity is soft deleted\n   * @type {Date | null}\n   */\n  @Prop({ type: Date, nullable: true, default: null })\n  deletedAt: Date | null;\n\n  /**\n   * Creates post instance from provided dto\n   * @param {CreatePostDomainDto} dto\n   */\n  static createPost(dto: CreatePostDomainDto): PostDocument {\n    const post = new this();\n    post.title = dto.title;\n    post.shortDescription = dto.shortDescription;\n    post.content = dto.content;\n    post.blogId = dto.blogId;\n    post.blogName = dto.blogName;\n    // post.extendedLikesInfo = {\n    //   likesCount: 0,\n    //   dislikesCount: 0,\n    //   newestLikes: [],\n    // };\n\n    return post as PostDocument;\n  }\n\n  /**\n   * Updates fields in post instance with provided values\n   * @param {UpdatePostDto} dto\n   */\n  updatePost(dto: UpdatePostDto) {\n    this.title = dto.title;\n    this.shortDescription = dto.shortDescription;\n    this.content = dto.content;\n    this.blogId = dto.blogId;\n    return;\n  }\n\n  /**\n   * Marks the post as deleted\n   * @throws {DomainException} if already deleted\n   */\n  markDeleted() {\n    if (this.deletedAt !== null) {\n      throw new DomainException({\n        code: DomainExceptionCode.NotFound,\n        message: 'Entity is already deleted',\n      });\n    }\n    this.deletedAt = new Date();\n  }\n\n  addLike() {\n    this.extendedLikesInfo.likesCount += 1;\n  }\n\n  removeLike() {\n    this.extendedLikesInfo.likesCount -= 1;\n  }\n\n  addDislike() {\n    this.extendedLikesInfo.dislikesCount += 1;\n  }\n\n  removeDislike() {\n    this.extendedLikesInfo.dislikesCount -= 1;\n  }\n\n  updateNewestLikes(recentLikes: PostLikeDocument[]) {\n    this.extendedLikesInfo.newestLikes = recentLikes.map((likeDoc) => {\n      return {\n        addedAt: likeDoc.updatedAt.toISOString(),\n        userId: likeDoc.userId,\n        login: likeDoc.login,\n      };\n    });\n  }\n}\n\nexport type PostDocument = HydratedDocument<Post>;\nexport type PostModelType = Model<PostDocument> & typeof Post;\nexport const PostSchema = SchemaFactory.createForClass(Post);\n\nPostSchema.loadClass(Post);\n"],"names":["Post","PostSchema","postContentConstr","postDescriptionConstr","postTitleConstr","maxLength","createPost","dto","post","title","shortDescription","content","blogId","blogName","updatePost","markDeleted","deletedAt","DomainException","code","DomainExceptionCode","NotFound","message","Date","addLike","extendedLikesInfo","likesCount","removeLike","addDislike","dislikesCount","removeDislike","updateNewestLikes","recentLikes","newestLikes","map","likeDoc","addedAt","updatedAt","toISOString","userId","login","type","String","required","ExtendedLikesInfoSchema","default","ExtendedLikesInfo","nullable","timestamps","SchemaFactory","createForClass","loadClass"],"mappings":";;;;;;;;;;;QA2BaA;eAAAA;;QAiIAC;eAAAA;;QA1IAC;eAAAA;;QAHAC;eAAAA;;QAHAC;eAAAA;;;0BAZ+B;kCAGZ;sCACI;qCAK7B;;;;;;;;;;AAGA,MAAMA,kBAAkB;IAC7BC,WAAW;AACb;AACO,MAAMF,wBAAwB;IACnCE,WAAW;AACb;AACO,MAAMH,oBAAoB;IAC/BG,WAAW;AACb;AAOO,IAAA,AAAML,OAAN,MAAMA;IAsDX;;;GAGC,GACD,OAAOM,WAAWC,GAAwB,EAAgB;QACxD,MAAMC,OAAO,IAAI,IAAI;QACrBA,KAAKC,KAAK,GAAGF,IAAIE,KAAK;QACtBD,KAAKE,gBAAgB,GAAGH,IAAIG,gBAAgB;QAC5CF,KAAKG,OAAO,GAAGJ,IAAII,OAAO;QAC1BH,KAAKI,MAAM,GAAGL,IAAIK,MAAM;QACxBJ,KAAKK,QAAQ,GAAGN,IAAIM,QAAQ;QAC5B,6BAA6B;QAC7B,mBAAmB;QACnB,sBAAsB;QACtB,qBAAqB;QACrB,KAAK;QAEL,OAAOL;IACT;IAEA;;;GAGC,GACDM,WAAWP,GAAkB,EAAE;QAC7B,IAAI,CAACE,KAAK,GAAGF,IAAIE,KAAK;QACtB,IAAI,CAACC,gBAAgB,GAAGH,IAAIG,gBAAgB;QAC5C,IAAI,CAACC,OAAO,GAAGJ,IAAII,OAAO;QAC1B,IAAI,CAACC,MAAM,GAAGL,IAAIK,MAAM;QACxB;IACF;IAEA;;;GAGC,GACDG,cAAc;QACZ,IAAI,IAAI,CAACC,SAAS,KAAK,MAAM;YAC3B,MAAM,IAAIC,iCAAe,CAAC;gBACxBC,MAAMC,yCAAmB,CAACC,QAAQ;gBAClCC,SAAS;YACX;QACF;QACA,IAAI,CAACL,SAAS,GAAG,IAAIM;IACvB;IAEAC,UAAU;QACR,IAAI,CAACC,iBAAiB,CAACC,UAAU,IAAI;IACvC;IAEAC,aAAa;QACX,IAAI,CAACF,iBAAiB,CAACC,UAAU,IAAI;IACvC;IAEAE,aAAa;QACX,IAAI,CAACH,iBAAiB,CAACI,aAAa,IAAI;IAC1C;IAEAC,gBAAgB;QACd,IAAI,CAACL,iBAAiB,CAACI,aAAa,IAAI;IAC1C;IAEAE,kBAAkBC,WAA+B,EAAE;QACjD,IAAI,CAACP,iBAAiB,CAACQ,WAAW,GAAGD,YAAYE,GAAG,CAAC,CAACC;YACpD,OAAO;gBACLC,SAASD,QAAQE,SAAS,CAACC,WAAW;gBACtCC,QAAQJ,QAAQI,MAAM;gBACtBC,OAAOL,QAAQK,KAAK;YACtB;QACF;IACF;AACF;;;QAxHUC,MAAMC;QAAQC,UAAU;QAAM,GAAGtC,eAAe;;;;;;QAOhDoC,MAAMC;QAAQC,UAAU;QAAM,GAAGvC,qBAAqB;;;;;;QAOtDqC,MAAMC;QAAQC,UAAU;QAAM,GAAGxC,iBAAiB;;;;;;QAOlDsC,MAAMC;QAAQC,UAAU;;;;;;QAGxBF,MAAMG,4CAAuB;QAAEC,SAAS,IAAIC,sCAAiB;;;;;;QAO7DL,MAAMC;QAAQC,UAAU;;;;;;QAexBF,MAAMlB;QAAMwB,UAAU;QAAMF,SAAS;;;;;;QApDrCG,YAAY;;;AAkIf,MAAM9C,aAAa+C,uBAAa,CAACC,cAAc,CAACjD;AAEvDC,WAAWiD,SAAS,CAAClD"}