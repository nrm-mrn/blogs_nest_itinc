{"version":3,"sources":["../../../../../src/modules/bloggers-platform/comments/infrastructure/comments.query-repository.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PaginatedViewDto } from 'src/core/dto/base.paginated.view-dto';\nimport { CommentViewDto } from '../api/view-dto/comment-view.dto';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Comment, CommentModelType } from '../domain/comment.entity';\nimport {\n  CommentLike,\n  CommentLikeModelType,\n} from '../domain/comment-like.entity';\nimport { DomainException } from 'src/core/exceptions/domain-exceptions';\nimport { DomainExceptionCode } from 'src/core/exceptions/domain-exception-codes';\nimport { GetCommentsForPostQueryDto } from '../dto/get-comments-for-post.dto';\nimport { GetCommentDto } from '../dto/get-comment-dto';\n\n@Injectable()\nexport class CommentsQueryRepository {\n  constructor(\n    @InjectModel(Comment.name) private readonly CommentModel: CommentModelType,\n    @InjectModel(CommentLike.name)\n    private readonly CommentLikeModel: CommentLikeModelType,\n  ) {}\n\n  async getCommentsForPost(\n    dto: GetCommentsForPostQueryDto,\n  ): Promise<PaginatedViewDto<CommentViewDto[]>> {\n    const comments = await this.CommentModel.find({\n      postId: dto.postId,\n      deletedAt: null,\n    })\n      .sort({ [dto.query.sortBy]: dto.query.sortDirection })\n      .skip(dto.query.calculateSkip())\n      .limit(dto.query.pageSize)\n      .exec();\n    const total = await this.CommentModel.countDocuments().exec();\n    const commentsView = comments.map((comment) =>\n      CommentViewDto.mapToView(comment),\n    );\n    if (dto.userId) {\n      const commentIds = comments.map((commentDoc) =>\n        commentDoc._id.toString(),\n      );\n      const likes = await this.CommentLikeModel.find({\n        userId: dto.userId,\n        commentId: { $in: commentIds },\n      });\n      const likesMap = new Map(\n        likes.map((like) => [like.commentId, like.status]),\n      );\n      commentsView.forEach((comment) => comment.setLike(likesMap));\n    }\n\n    return PaginatedViewDto.mapToView({\n      items: commentsView,\n      page: dto.query.pageNumber,\n      size: dto.query.pageSize,\n      totalCount: total,\n    });\n  }\n\n  async findCommentOrNotFoundFail(dto: GetCommentDto): Promise<CommentViewDto> {\n    const comment = await this.CommentModel.findOne({\n      _id: dto.commentId,\n      deletedAt: null,\n    }).orFail(\n      new DomainException({\n        code: DomainExceptionCode.NotFound,\n        message: 'Comment not found',\n      }),\n    );\n    const commentView = CommentViewDto.mapToView(comment);\n\n    if (dto.userId) {\n      const like = await this.CommentLikeModel.findOne({\n        commentId: dto.commentId,\n        userId: dto.userId,\n      });\n      if (like) {\n        commentView.setLike(like);\n      }\n    }\n    return commentView;\n  }\n}\n"],"names":["CommentsQueryRepository","getCommentsForPost","dto","comments","CommentModel","find","postId","deletedAt","sort","query","sortBy","sortDirection","skip","calculateSkip","limit","pageSize","exec","total","countDocuments","commentsView","map","comment","CommentViewDto","mapToView","userId","commentIds","commentDoc","_id","toString","likes","CommentLikeModel","commentId","$in","likesMap","Map","like","status","forEach","setLike","PaginatedViewDto","items","page","pageNumber","size","totalCount","findCommentOrNotFoundFail","findOne","orFail","DomainException","code","DomainExceptionCode","NotFound","message","commentView","constructor","name"],"mappings":";;;;+BAeaA;;;eAAAA;;;wBAfc;sCACM;gCACF;0BACH;+BACc;mCAInC;kCACyB;sCACI;;;;;;;;;;;;;;;AAK7B,IAAA,AAAMA,0BAAN,MAAMA;IAOX,MAAMC,mBACJC,GAA+B,EACc;QAC7C,MAAMC,WAAW,MAAM,IAAI,CAACC,YAAY,CAACC,IAAI,CAAC;YAC5CC,QAAQJ,IAAII,MAAM;YAClBC,WAAW;QACb,GACGC,IAAI,CAAC;YAAE,CAACN,IAAIO,KAAK,CAACC,MAAM,CAAC,EAAER,IAAIO,KAAK,CAACE,aAAa;QAAC,GACnDC,IAAI,CAACV,IAAIO,KAAK,CAACI,aAAa,IAC5BC,KAAK,CAACZ,IAAIO,KAAK,CAACM,QAAQ,EACxBC,IAAI;QACP,MAAMC,QAAQ,MAAM,IAAI,CAACb,YAAY,CAACc,cAAc,GAAGF,IAAI;QAC3D,MAAMG,eAAehB,SAASiB,GAAG,CAAC,CAACC,UACjCC,8BAAc,CAACC,SAAS,CAACF;QAE3B,IAAInB,IAAIsB,MAAM,EAAE;YACd,MAAMC,aAAatB,SAASiB,GAAG,CAAC,CAACM,aAC/BA,WAAWC,GAAG,CAACC,QAAQ;YAEzB,MAAMC,QAAQ,MAAM,IAAI,CAACC,gBAAgB,CAACzB,IAAI,CAAC;gBAC7CmB,QAAQtB,IAAIsB,MAAM;gBAClBO,WAAW;oBAAEC,KAAKP;gBAAW;YAC/B;YACA,MAAMQ,WAAW,IAAIC,IACnBL,MAAMT,GAAG,CAAC,CAACe,OAAS;oBAACA,KAAKJ,SAAS;oBAAEI,KAAKC,MAAM;iBAAC;YAEnDjB,aAAakB,OAAO,CAAC,CAAChB,UAAYA,QAAQiB,OAAO,CAACL;QACpD;QAEA,OAAOM,sCAAgB,CAAChB,SAAS,CAAC;YAChCiB,OAAOrB;YACPsB,MAAMvC,IAAIO,KAAK,CAACiC,UAAU;YAC1BC,MAAMzC,IAAIO,KAAK,CAACM,QAAQ;YACxB6B,YAAY3B;QACd;IACF;IAEA,MAAM4B,0BAA0B3C,GAAkB,EAA2B;QAC3E,MAAMmB,UAAU,MAAM,IAAI,CAACjB,YAAY,CAAC0C,OAAO,CAAC;YAC9CnB,KAAKzB,IAAI6B,SAAS;YAClBxB,WAAW;QACb,GAAGwC,MAAM,CACP,IAAIC,iCAAe,CAAC;YAClBC,MAAMC,yCAAmB,CAACC,QAAQ;YAClCC,SAAS;QACX;QAEF,MAAMC,cAAc/B,8BAAc,CAACC,SAAS,CAACF;QAE7C,IAAInB,IAAIsB,MAAM,EAAE;YACd,MAAMW,OAAO,MAAM,IAAI,CAACL,gBAAgB,CAACgB,OAAO,CAAC;gBAC/Cf,WAAW7B,IAAI6B,SAAS;gBACxBP,QAAQtB,IAAIsB,MAAM;YACpB;YACA,IAAIW,MAAM;gBACRkB,YAAYf,OAAO,CAACH;YACtB;QACF;QACA,OAAOkB;IACT;IAjEAC,YACE,AAA4ClD,YAA8B,EAC1E,AACiB0B,gBAAsC,CACvD;aAH4C1B,eAAAA;aAE3B0B,mBAAAA;IAChB;AA8DL;;;mEAjEyByB;2EACIA"}